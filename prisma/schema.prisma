generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PredictionStatus {
  PENDING
  REVIEWED
}

model Draw {
  id                 Int                @id @default(autoincrement())
  issueNo            String             @unique
  drawDate           DateTime
  numbersJson        String
  specialNumber      Int
  source             String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  predictionReviews  PredictionReview[]

  @@index([drawDate])
}

model PredictionRun {
  id              Int              @id @default(autoincrement())
  issueNo         String
  strategy        String
  strategyVersion String
  status          PredictionStatus @default(PENDING)
  hitCount        Int?
  hitRate         Float?
  createdAt       DateTime         @default(now())
  reviewedAt      DateTime?
  picks           PredictionPick[]
  review          PredictionReview?

  @@index([issueNo])
  @@index([strategy])
  @@unique([issueNo, strategy, strategyVersion])
}

model PredictionPick {
  id      Int           @id @default(autoincrement())
  runId   Int
  number  Int
  rank    Int
  score   Float
  reason  String
  run     PredictionRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, number])
}

model PredictionReview {
  id               Int           @id @default(autoincrement())
  runId             Int           @unique
  drawId            Int
  matchedNumbersJson String
  hitCount          Int
  hitRate           Float
  createdAt         DateTime      @default(now())
  run               PredictionRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  draw              Draw          @relation(fields: [drawId], references: [id], onDelete: Cascade)

  @@unique([runId, drawId])
}

model SystemState {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
